{% extends "base.html" %}
{% load static wagtailimages_tags %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
    <link rel="stylesheet" href="{% static 'home/assets_shop/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'home/assets_shop/css/colors/color-1.css' %}">
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        /* --- Split Layout Styles --- */
        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            align-items: start;
            margin-top: 2rem;
        }

        /* Order Summary (Left Side) */
        .order-summary {
            background-color: var(--container-color);
            padding: 2rem;
            border-radius: 1rem;
            border: 1px solid var(--scroll-bar-color);
            position: sticky;
            top: 6rem; /* Sticks when scrolling */
        }

        .order-title {
            font-size: var(--h3-font-size);
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--scroll-bar-color);
            padding-bottom: 1rem;
        }

        .summary-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 0.5rem;
            background: #f1f1f1;
        }

        .summary-info h4 {
            font-size: var(--normal-font-size);
            font-weight: var(--font-medium);
            margin-bottom: 0.25rem;
        }

        .summary-meta {
            font-size: var(--small-font-size);
            color: var(--text-color-light);
        }

        .summary-totals {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--scroll-bar-color);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: var(--normal-font-size);
        }

        .total-final {
            font-size: var(--h2-font-size);
            font-weight: var(--font-bold);
            color: var(--title-color);
            margin-top: 1rem;
        }

        /* Checkout Form (Right Side) */
        #checkout {
            min-height: 400px;
        }

        /* Mobile Responsive */
        @media screen and (max-width: 992px) {
            .checkout-grid {
                grid-template-columns: 1fr; /* Stack vertically */
                gap: 2rem;
            }
            .order-summary {
                position: static; /* Unstick on mobile */
                order: 1; /* Move summary below checkout if desired, or remove to keep top */
            }
        }
    </style>
{% endblock %}
{% block content %}
<main class="main">
    <section class="section container">
        
        {% if success %}
            <div style="text-align: center; padding: 4rem 0;">
                <i class='bx bx-check-circle' style="font-size: 4rem; color: #27ae60; margin-bottom: 1rem;"></i>
                <h2 class="section__title">Thank you, {{ order.first_name }}!</h2>
                <p style="margin-bottom: 2rem; color: var(--text-color);">
                    Your order <strong>#{{ order.id }}</strong> has been successfully placed.
                </p>
                <a href="{% url 'index_shop' %}" class="button">Continue Shopping</a>
            </div>

        {% else %}
            <h2 class="section__title">Checkout</h2>
            
            <div id="checkout" style="min-height: 400px;">
                <div style="text-align: center; padding: 2rem; color: var(--text-color);">
                    <i class="bx bx-loader-alt bx-spin" style="font-size: 2rem;"></i>
                    <p>Loading secure checkout...</p>
                </div>
            </div>
            
            <div id="error-message" style="color: red; text-align: center; display: none; padding: 1rem; background: #ffe6e6; border-radius: 8px; margin-top: 1rem;"></div>
        {% endif %}

    </section>
</main>
{% endblock %}

{% block extra_js %}
{{ block.super }}
{% if not success %}
<script>
    const stripeKey = "{{ STRIPE_PUBLISHABLE_KEY }}";
    const clientSecret = "{{ client_secret }}";

    if (!stripeKey || !clientSecret) {
        showError("Error: Stripe configuration is missing.");
    } else {
        const stripe = Stripe(stripeKey);

        (async () => {
            try {
                const checkout = await stripe.initEmbeddedCheckout({
                    clientSecret: clientSecret,
                });

                document.getElementById('checkout').innerHTML = ''; 
                checkout.mount('#checkout');
            } catch (e) {
                console.error("Stripe Init Error:", e);
                showError(`Stripe Error: ${e.message}`);
            }
        })();
    }

    function showError(msg) {
        const errDiv = document.getElementById('error-message');
        const loadingDiv = document.getElementById('checkout');
        if(loadingDiv) loadingDiv.style.display = 'none';
        if(errDiv) {
            errDiv.style.display = 'block';
            errDiv.innerText = msg;
        }
    }
</script>
{% endif %}
{% endblock %}