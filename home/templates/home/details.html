{% extends "base.html" %}
{% load static wagtailcore_tags wagtailimages_tags %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
    <link rel="stylesheet" href="{% static 'home/assets_shop/css/swiper-bundle.min.css' %}">
    
    <link rel="stylesheet" href="{% static 'home/assets_shop/css/style.css' %}?v=1.0.9">
    
    <link rel="stylesheet" href="{% static 'home/assets_shop/css/colors/color-1.css' %}">
{% endblock %}
{% block content %}

<div class="cart" id="cart">
        <i class="bx bx-x cart__close" id="cart-close"></i>

        <h2 class="cart__title-center">My Cart</h2>

        <div class="cart__container">
            <article class="cart__card">
                <div class="cart__box">
                    {# PFAD KORRIGIERT #}
                    <img src="{% static 'home/assets_shop/img/cart-1.png' %}" alt="" class="cart__img">
                </div>

                <div class="cart__details">
                    <h3 class="cart__title">Windbreaker</h3>
                    <span class="cart__price">$12</span>

                    <div class="cart__amount">
                        <div class="cart__amount-content">
                            <span class="cart__amount-box">
                                <i class="bx bx-minus"></i>
                            </span>

                            <span class="cart__amount-number">1</span>

                            <span class="cart__amount-box">
                                <i class="bx bx-plus"></i>
                            </span>
                        </div>

                        <i class="bx bx-trash-alt cart__amount-trash"></i>
                    </div>
                </div>
            </article>

            <article class="cart__card">
                <div class="cart__box">
                    {# PFAD KORRIGIERT #}
                    <img src="{% static 'home/assets_shop/img/cart-2.png' %}" alt="" class="cart__img">
                </div>

                <div class="cart__details">
                    <h3 class="cart__title">Cardigan Hoodie</h3>
                    <span class="cart__price">$16</span>

                    <div class="cart__amount">
                        <div class="cart__amount-content">
                            <span class="cart__amount-box">
                                <i class="bx bx-minus"></i>
                            </span>

                            <span class="cart__amount-number">1</span>

                            <span class="cart__amount-box">
                                <i class="bx bx-plus"></i>
                            </span>
                        </div>

                        <i class="bx bx-trash-alt cart__amount-trash"></i>
                    </div>
                </div>
            </article>

            <article class="cart__card">
                <div class="cart__box">
                    {# PFAD KORRIGIERT #}
                    <img src="{% static 'home/assets_shop/img/cart-3.png' %}" alt="" class="cart__img">
                </div>

                <div class="cart__details">
                    <h3 class="cart__title">Cartoon</h3>
                    <span class="cart__price">$10</span>

                    <div class="cart__amount">
                        <div class="cart__amount-content">
                            <span class="cart__amount-box">
                                <i class="bx bx-minus"></i>
                            </span>

                            <span class="cart__amount-number">1</span>

                            <span class="cart__amount-box">
                                <i class="bx bx-plus"></i>
                            </span>
                        </div>

                        <i class="bx bx-trash-alt cart__amount-trash"></i>
                    </div>
                </div>
            </article>
        </div>

        <div class="cart__prices">
            <span class="cart__prices-item">3 item</span>
            <span class="cart__prices-total">$38</span>
        </div>
    </div>

    <main class="main">
        <section class="details section container">
            <h2 class="breadcrumb__title">Details Page</h2>
            
            <h3 class="breadcrumb__subtitle"><a href="{% pageurl page.get_parent %}">Shop</a> > <span>{{ page.title }}</span></h3>

            <div class="details__container grid">
                <div class="product__images grid">
                    
                    {% if page.product_image %}
                        <div class="product__img">
                            {% image page.product_image height-1000 alt=page.title %}
                        </div>
                    {% endif %}
                </div>

                <div class="product__info">
                    {% if page.orientation %}
                        <p class="details__subtitle">{{ page.orientation | title }}</p>
                    {% endif %}
                    
                    <h3 class="details__title">{{ page.title }}</h3>

                    <div class="details__prices">
                        {# This price is now set by JavaScript #}
                        <span class="details__price" id="product-price">--.-- €</span>
                    </div>


                    <div class="details__description" style="margin-top: var(--mb-2);">
                        <div class="simple-description">
                            {{ page.description_text | linebreaks }}
                        </div>
                    </div>


                <form action="{% url 'add_to_cart' product_id=page.id %}" method="POST" id="add-to-cart-form">
                    {% csrf_token %}
                    
                    {% with all_variants as variants %}
                        {% if variants %}
                            <div class="option-toggle" role="group" aria-label="Größe" style="margin-bottom: 1rem;">

                                {% for variant in variants %}
                                <label class="opt {% if forloop.first %}is-active{% endif %}">
                                    <input type="radio" 
                                        name="size_variant" 
                                        id="size_{{ variant.id }}" 
                                        value="{{ variant.id }}" 
                                        {% if forloop.first %}checked{% endif %}>
                                    <span>{{ variant.size_name }}</span>
                                </label>
                                {% endfor %}

                            </div>
                            
                            {% include "home/components/option_toggle.html" with name="add_frame" id_off="frame_no" id_on="frame_yes" label_off="No Frame" label_on="With Frame" value=False %}
                        
                        {% else %}
                            <p>Dieses Produkt ist derzeit nicht verfügbar.</p>
                        {% endif %}
                    {% endwith %}

                    <button type="submit" class="button" id="add-to-cart-btn" style="width: 100%; margin-top: var(--mb-1-5);">Add To Cart</button>
                </form>

                    </div>
            </div>
        </section>

        <section class="related__products section">
        <h2 class="section__title">Related Products</h2>

        <div class="new__container container">
            <div class="swiper new-swiper">
                <div class="swiper-wrapper">
                    
                    {% for product in related_products %}
                    <div class="shop__content swiper-slide">
                        <a href="{% pageurl product %}" class="related-product__main-link">
                            {% if product.product_image %}
                                {% image product.product_image width-300 alt=product.title class="shop__img" %}
                            {% endif %}
                            <h3 class="shop__title">{{ product.title }}</h3>
                        </a>
                        
                        {% if product.orientation %}
                            <span class="shop__subtitle">{{ product.orientation | title }}</span>
                        {% else %}
                            <span class="shop__subtitle">Product</span>
                        {% endif %}

                        <div class="shop__prices">
                        
                        {% with all_variants|first as first_variant %}
                            {% if first_variant %}
                                <span class="shop__price">From {{ first_variant.base_price }} €</span>
                            {% endif %}
                        {% endwith %}
                        </div>

                        <a href="{% pageurl product %}" class="button shop__button">
                            <i class="bx bx-cart-alt shop__icon"></i>
                        </a>
                    </div>
                    {% endfor %}
                    
                </div>
            </div>
        </div>
    </section>
</main>
    <footer class="footer section">
        <div class="footer__container container grid">
            
            <div class="footer__content">
                <a href="#" class="footer__logo">
                     <img src="{% static 'home/assets/images/logo_cumulophib.png' %}" alt="Logo" style="height: 2.5em; vertical-align: middle; margin-right: 0.5em;">
                </a>
                <p class="footer__description"> Danke! </p>
                <div class="footer__social">
                    <a href="https://www.instagram.com/cumulophib/" class="footer__social-link"><i class="bx bxl-instagram-alt"></i></a>
                </div>
            </div>

            <div class="footer__content">
                <h3 class="footer__title">About</h3>
                <ul class="footer__links">
                    {% if about_page %}
                        <li><a href="{% pageurl about_page %}" class="footer__link">About Us</a></li>
                    {% endif %}
                    <li><a href="#" class="footer__link">Customer Support</a></li>
                    <li><a href="#" class="footer__link">Support Center</a></li>
                </ul>
            </div>

            <div class="footer__content">
                <h3 class="footer__title">Our Services</h3>
                <ul class="footer__links">
                    {% if index_shop_page %}
                        <li><a href="{% pageurl index_shop_page %}" class="footer__link">Shop</a></li>
                    {% endif %}
                    <li><a href="#" class="footer__link">Discounts</a></li>
                    <li><a href="#" class="footer__link">Shipping mode</a></li>
                </ul>
            </div>

            <div class="footer__content">
                <h3 class="footer__title">Our Company</h3>
                <ul class="footer__links">
                    {% if registration_page %}
                        <li><a href="{% pageurl registration_page %}" class="footer__link">Register</a></li>
                    {% endif %}
                    {% if contact_page %}
                        <li><a href="{% pageurl contact_page %}" class="footer__link">Contact Us</a></li>
                    {% endif %}
                    {% if about_page %}
                        <li><a href="{% pageurl about_page %}" class="footer__link">About Us</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <span class="footer__copy">&#169; Crypticalcoder. All rights reserved</span>
    </footer>

    <div class="lightbox">
        <div class="lightbox__content">
            <div class="lightbox__close">&times;</div>
            {# PFAD KORRIGIERT #}
            <img src="{% static 'home/assets_shop/img/details-2.png' %}" alt="" class="lightbox__img">
            <div class="lightbox__caption">
                <div class="caption__text">cumulophib</div>
                <div class="caption__counter"></div>
            </div>
        </div>

        <div class="lightbox__controls">
            <div class="prev__item" onclick="prevItem()"><i class="bx bx-chevron-left"></i></div>
            <div class="next__item" onclick="nextItem()"><i class="bx bx-chevron-right"></i></div>
        </div>
    </div>

    <a href="#" class="scrollup" id="scroll-up">
        <i class="bx bx-up-arrow-alt scrollup__icon"></i>
    </a>

    <script>
        const productItems = document.querySelectorAll(".product__img"),
              totalProductItems = productItems.length,
              lightbox = document.querySelector(".lightbox"),
              lightboxImg = lightbox.querySelector(".lightbox__img"),
              lightboxClose = lightbox.querySelector(".lightbox__close"),
              lightboxCounter = lightbox.querySelector(".caption__counter");
        let itemIndex = 0;

        for(let i=0; i<totalProductItems; i++) {
            productItems[i].addEventListener("click", function() {
                itemIndex=i;
                changeItem();
                toggleLightbox();
            })
        }

        function nextItem() {
            if(itemIndex === totalProductItems-1) {
                itemIndex=0;
            }

            else{
                itemIndex++
            }
            changeItem()
        }

        function prevItem() {
            if(itemIndex === 0) {
                itemIndex=totalProductItems-1;
            }

            else{
                itemIndex--
            }
            changeItem()
        }

        function toggleLightbox() {
            lightbox.classList.toggle("open");
        }

        function changeItem() {
            // Dieses Skript sucht nach dem 'img'-Tag innerhalb des angeklickten '.product__img'
            let imgTag = productItems[itemIndex].querySelector("img");
            if (imgTag) {
                let imgSrc = imgTag.getAttribute("src");
                lightboxImg.src = imgSrc;
                lightboxCounter.innerHTML = (itemIndex + 1) + " of " + totalProductItems;
            }
        }

        // close lightbox (event-Variable hinzugefügt)
        lightbox.addEventListener("click", function(event) {
            if(event.target === lightboxClose || event.target === lightbox) {
                toggleLightbox()
            }
        })
    </script>

    {# PFAD KORRIGIERT #}
    <script src="{% static 'home/assets_shop/js/swiper-bundle.min.js' %}"></script>

    {# PFAD KORRIGIERT #}
    <script src="{% static 'home/assets_shop/js/main.js' %}"></script>

{# HIER ENDET DER 'content' BLOCK, DER IN 'base.html' EINGEFÜGT WIRD #}
{% endblock %}

{% block extra_js %}
    {{ block.super }} {# Inherits scripts from base.html #}

    <script src="{% static 'home/assets_shop/js/swiper-bundle.min.js' %}?v=1.0.9"></script>
    <script src="{% static 'home/assets_shop/js/main.js' %}?v=1.0.9"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // This script runs on page load and checks the URL
        // to re-select any options from the previous page load.
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const sizeId = urlParams.get('size');
            const frame = urlParams.get('frame'); // "true" or "false"

            if (sizeId) {
                const sizeInput = document.querySelector('input[name="size_variant"][value="' + sizeId + '"]');
                if (sizeInput) {
                    sizeInput.checked = true;
                    // Manually update the visual style
                    document.querySelectorAll('.option-toggle[aria-label="Größe"] .opt').forEach(label => label.classList.remove('is-active'));
                    sizeInput.parentElement.classList.add('is-active');
                }
            }
            
            if (frame) {
                const frameInput = document.querySelector('input[name="add_frame"][value="' + frame + '"]');
                if (frameInput) {
                    frameInput.checked = true;
                    // Manually update the visual style
                    document.querySelectorAll('.option-toggle[aria-label="Option state"] .opt').forEach(label => label.classList.remove('is-active'));
                    frameInput.parentElement.classList.add('is-active');
                }
            }
        } catch (e) {
            console.error("Error setting toggles from URL:", e);
        }
    });
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. Create a "map" of all prices from your new Wagtail model
            const priceData = {
            {% for variant in all_variants %}
                '{{ variant.id }}': {   // <-- variant.id instead of variant.size_price.id
                    'base': {{ variant.base_price | floatformat:2 }}, 
                    'frame_addon': {{ variant.frame_addon_price | floatformat:2 }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
            };

        const priceDisplay = document.getElementById('product-price');
        // Find ALL radio buttons for size and frame
        const sizeRadios = document.querySelectorAll('input[name="size_variant"]');
        const frameRadios = document.querySelectorAll('input[name="add_frame"]');

        function updatePrice() {
            try {
                // 2. Find the *currently selected* options
                const selectedSizeId = document.querySelector('input[name="size_variant"]:checked').value;
                const selectedFrame = document.querySelector('input[name="add_frame"]:checked').value; // "true" or "false"

                // 3. Get the prices from our map
                const prices = priceData[selectedSizeId];
                if (!prices) {
                    priceDisplay.textContent = 'Error';
                    return;
                }

                // 4. Calculate the final price
                let finalPrice = prices.base;
                if (selectedFrame === 'true') {
                    finalPrice += prices.frame_addon;
                }

                // 5. Update the page
                priceDisplay.textContent = finalPrice.toFixed(2) + ' €';
            
            } catch (e) {
                // This might fail if no priceData exists, which is ok
                priceDisplay.textContent = 'N/A';
                console.log("Could not update price:", e.message);
            }
        }

        // 6. Add event listeners
        // When *any* size radio changes, run updatePrice
        sizeRadios.forEach(radio => {
            radio.addEventListener('change', updatePrice);
        });
        
        // When *any* frame radio changes, run updatePrice
        frameRadios.forEach(radio => {
            radio.addEventListener('change', updatePrice);
        });

        // 7. Run once on page load to set the initial price
        // This will use the default 'checked' values (or the ones
        // set by the URL param script above).
        updatePrice();
    });
    </script>
    
    <script>
        const productItems = document.querySelectorAll(".product__img"),
              totalProductItems = productItems.length,
              lightbox = document.querySelector(".lightbox"),
              lightboxImg = lightbox.querySelector(".lightbox__img"),
              lightboxClose = lightbox.querySelector(".lightbox__close"),
              lightboxCounter = lightbox.querySelector(".caption__counter");
        let itemIndex = 0;

        for(let i=0; i<totalProductItems; i++) {
            productItems[i].addEventListener("click", function() {
                itemIndex=i;
                changeItem();
                toggleLightbox();
            })
        }

        function nextItem() {
            if(itemIndex === totalProductItems-1) {
                itemIndex=0;
            }
            else{
                itemIndex++
            }
            changeItem()
        }

        function prevItem() {
            if(itemIndex === 0) {
                itemIndex=totalProductItems-1;
            }
            else{
                itemIndex--
            }
            changeItem()
        }

        function toggleLightbox() {
            lightbox.classList.toggle("open");
        }

        function changeItem() {
            let imgTag = productItems[itemIndex].querySelector("img");
            if (imgTag) {
                let imgSrc = imgTag.getAttribute("src");
                lightboxImg.src = imgSrc;
                lightboxCounter.innerHTML = (itemIndex + 1) + " of " + totalProductItems;
            }
        }

        // close lightbox
        lightbox.addEventListener("click", function(event) {
            if(event.target === lightboxClose || event.target === lightbox) {
                toggleLightbox()
            }
        })
    </script>
{% endblock %}